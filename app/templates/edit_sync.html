<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Sync - CalendarSync</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body>
    <header class="header">
        <a href="/" class="logo-container">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="CalendarSync Logo" class="logo-img">
            <span class="logo-text">CalendarSync</span>
        </a>
        <div class="user-menu">
            {% if user %}
            <span>{{ user.name }}</span>
            <img src="{{ user.picture }}" alt="Profile" style="width: 32px; height: 32px; border-radius: 50%;">
            <a href="/logout" class="btn btn-outline">Sign Out</a>
            {% endif %}
        </div>
    </header>

    <main class="dashboard-container">
        <div class="form-card">
            <h1>Edit Sync</h1>
            <form action="/edit_sync/{{ sync.id }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="form-group">
                    <label for="destination_calendar_id">Destination Calendar</label>
                    {% if calendars %}
                    <select id="destination_calendar_id" name="destination_calendar_id" required>
                        <option value="" disabled>Select a calendar</option>
                        {% for cal in calendars %}
                        <option value="{{ cal.id }}" {% if cal.id==sync.destination_calendar_id %}selected{% endif %}>
                            {{ cal.summary }}
                        </option>
                        {% endfor %}
                    </select>
                    {% else %}
                    <input type="text" id="destination_calendar_id" name="destination_calendar_id"
                        value="{{ sync.destination_calendar_id }}" required>
                    {% endif %}
                    <div class="helper-text">Select the Google Calendar you want to sync events TO.</div>
                </div>

                <div class="form-group">
                    <label>Source Calendars</label>
                    <div class="info-box"
                        style="background: #e8f0fe; padding: 10px; border-radius: 6px; margin-bottom: 1rem; font-size: 0.9rem; color: #1a73e8;">
                        <p style="margin: 0;"><strong>How to add sources:</strong></p>
                        <ul style="margin: 5px 0 0 1.2rem; padding: 0;">
                            <li>Use <strong>Google Calendar</strong> to sync from your other personal Google calendars.
                            </li>
                            <li>Use <strong>iCal URL</strong> for external calendars (like Outlook, iCloud, or public
                                holidays).</li>
                        </ul>
                    </div>

                    <div id="ical-container">
                        {% for source in sync.sources %}
                        <div class="ical-entry"
                            style="{% if not loop.first %}margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #eee;{% endif %}">
                            <input type="hidden" name="source_types" value="{{ source.type or 'ical' }}">
                            <input type="hidden" name="source_ids" value="{{ source.id or '' }}">

                            <div class="source-type-select" style="margin-bottom: 0.5rem;">
                                <label style="font-size: 0.8rem; color: #666; margin-right: 0.5rem;">Source
                                    Type:</label>
                                <select onchange="changeSourceType(this)"
                                    style="padding: 0.3rem; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="ical" {% if (source.type or 'ical' )=='ical' %}selected{% endif %}>
                                        iCal URL</option>
                                    <option value="google" {% if source.type=='google' %}selected{% endif %}>Google
                                        Calendar</option>
                                </select>
                            </div>

                            <div class="input-row google-input"
                                style="display: {% if source.type == 'google' %}block{% else %}none{% endif %};">
                                {% if calendars %}
                                <select name="source_ids_visible" onchange="updateHiddenId(this)"
                                    style="width: 100%; padding: 0.6rem; border: 1px solid #dfe1e5; border-radius: 6px;">
                                    <option value="" disabled {% if not source.id %}selected{% endif %}>Select a Google
                                        Calendar source</option>
                                    {% for cal in calendars %}
                                    <option value="{{ cal.id }}" {% if cal.id==source.id %}selected{% endif %}>{{
                                        cal.summary }}</option>
                                    {% endfor %}
                                </select>
                                {% else %}
                                <p style="color: #666; font-size: 0.9rem;">No Google Calendars available.</p>
                                {% endif %}
                            </div>

                            <div class="input-row ical-input"
                                style="display: {% if (source.type or 'ical') == 'ical' %}block{% else %}none{% endif %};">
                                <input type="text" name="source_urls" value="{{ source.url }}"
                                    placeholder="https://example.com/calendar.ics" aria-label="Source Calendar URL">
                            </div>

                            <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                                <input type="text" name="source_prefixes" value="{{ source.prefix or '' }}"
                                    placeholder="Prefix (e.g. Work)" aria-label="Source Event Prefix" style="flex: 1;">
                                <button type="button" class="btn btn-danger" onclick="removeEntry(this)">Remove</button>
                            </div>
                        </div>
                        {% endfor %}

                        {% if not sync.sources %}
                        <!-- Fallback empty state -->
                        <div class="ical-entry">
                            <input type="hidden" name="source_types" value="ical">
                            <input type="hidden" name="source_ids" value="">

                            <div class="source-type-select" style="margin-bottom: 0.5rem;">
                                <label style="font-size: 0.8rem; color: #666; margin-right: 0.5rem;">Source
                                    Type:</label>
                                <select onchange="changeSourceType(this)"
                                    style="padding: 0.3rem; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="ical">iCal URL</option>
                                    <option value="google">Google Calendar</option>
                                </select>
                            </div>

                            <div class="input-row google-input" style="display: none;">
                                {% if calendars %}
                                <select name="source_ids_visible" onchange="updateHiddenId(this)"
                                    style="width: 100%; padding: 0.6rem; border: 1px solid #dfe1e5; border-radius: 6px;">
                                    <option value="" disabled selected>Select a Google Calendar source</option>
                                    {% for cal in calendars %}
                                    <option value="{{ cal.id }}">{{ cal.summary }}</option>
                                    {% endfor %}
                                </select>
                                {% else %}
                                <p style="color: #666; font-size: 0.9rem;">No Google Calendars available.</p>
                                {% endif %}
                            </div>

                            <div class="input-row ical-input">
                                <input type="text" name="source_urls" placeholder="https://example.com/calendar.ics"
                                    aria-label="Source Calendar URL">
                            </div>

                            <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                                <input type="text" name="source_prefixes" placeholder="Prefix (e.g. Work)"
                                    aria-label="Source Event Prefix" style="flex: 1;">
                                <button type="button" class="btn btn-danger" onclick="removeEntry(this)">Remove</button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <button type="button" class="add-btn" onclick="addSourceInput()">+ Add another Source</button>
                </div>

                <div class="buttons">
                    <a href="/" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">Update Sync</button>
                </div>
            </form>
        </div>
    </main>

    <footer>
        <p>&copy; 2024 CalendarSync. All rights reserved.</p>
    </footer>

    <template id="source-entry-template">
        <div class="ical-entry" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #eee;">
            <input type="hidden" name="source_types" value="ical">
            <input type="hidden" name="source_ids" value="">

            <div class="source-type-select" style="margin-bottom: 0.5rem;">
                <label style="font-size: 0.8rem; color: #666; margin-right: 0.5rem;">Source Type:</label>
                <select onchange="changeSourceType(this)"
                    style="padding: 0.3rem; border-radius: 4px; border: 1px solid #ddd;">
                    <option value="ical">iCal URL</option>
                    <option value="google">Google Calendar</option>
                </select>
            </div>

            <div class="input-row google-input" style="display: none;">
                {% if calendars %}
                <select name="source_ids_visible" onchange="updateHiddenId(this)"
                    style="width: 100%; padding: 0.6rem; border: 1px solid #dfe1e5; border-radius: 6px;">
                    <option value="" disabled selected>Select a Google Calendar source</option>
                    {% for cal in calendars %}
                    <option value="{{ cal.id }}">{{ cal.summary }}</option>
                    {% endfor %}
                </select>
                {% else %}
                <p style="color: #666; font-size: 0.9rem;">No Google Calendars found.</p>
                {% endif %}
            </div>

            <div class="input-row ical-input">
                <input type="text" name="source_urls" placeholder="https://example.com/calendar.ics"
                    aria-label="Source Calendar URL">
            </div>

            <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                <input type="text" name="source_prefixes" placeholder="Prefix (e.g. Work)"
                    aria-label="Source Event Prefix" style="flex: 1;">
                <button type="button" class="btn btn-danger" onclick="removeEntry(this)">Remove</button>
            </div>
        </div>
    </template>

    <script>
        function addSourceInput() {
            const container = document.getElementById('ical-container');
            const template = document.getElementById('source-entry-template');
            const clone = template.content.cloneNode(true);
            container.appendChild(clone);
            updateRemoveButtons();
        }

        function removeEntry(btn) {
            const entry = btn.closest('.ical-entry');
            entry.remove();
            updateRemoveButtons();
        }

        function updateRemoveButtons() {
            const entries = document.querySelectorAll('.ical-entry');
            entries.forEach((entry, index) => {
                const btn = entry.querySelector('.btn-danger');
                if (entries.length === 1) {
                    btn.style.visibility = 'hidden';
                } else {
                    btn.style.visibility = 'visible';
                }
            });
        }

        function changeSourceType(select) {
            const entry = select.closest('.ical-entry');
            const typeInput = entry.querySelector('input[name="source_types"]');
            const googleInput = entry.querySelector('.google-input');
            const icalInput = entry.querySelector('.ical-input');
            const idInput = entry.querySelector('input[name="source_ids"]');
            const urlInput = entry.querySelector('input[name="source_urls"]');

            typeInput.value = select.value;

            if (select.value === 'google') {
                googleInput.style.display = 'block';
                icalInput.style.display = 'none';
                urlInput.value = '';
            } else {
                googleInput.style.display = 'none';
                icalInput.style.display = 'block';
                idInput.value = '';
                const visibleSelect = entry.querySelector('select[name="source_ids_visible"]');
                if (visibleSelect) visibleSelect.value = "";
            }
        }

        function updateHiddenId(select) {
            const entry = select.closest('.ical-entry');
            const idInput = entry.querySelector('input[name="source_ids"]');
            idInput.value = select.value;
        }

        document.addEventListener('DOMContentLoaded', updateRemoveButtons);
    </script>
</body>

</html>