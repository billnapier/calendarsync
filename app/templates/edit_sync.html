<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Sync - CalendarSync</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body>
    <header class="header">
        <a href="/" class="logo-container">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="CalendarSync Logo" class="logo-img">
            <span class="logo-text">CalendarSync</span>
        </a>
        <div class="user-menu">
            {% if user %}
            <span>{{ user.name }}</span>
            <img src="{{ user.picture }}" alt="Profile" style="width: 32px; height: 32px; border-radius: 50%;">
            <a href="/logout" class="btn btn-outline">Sign Out</a>
            {% endif %}
        </div>
    </header>

    <main class="dashboard-container">
        <div class="form-card">
            <h1>Edit Sync</h1>
            <form action="/edit_sync/{{ sync.id }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="form-group">
                    <label for="destination_calendar_id">Destination Calendar</label>
                    {% if calendars %}
                    <select id="destination_calendar_id" name="destination_calendar_id" required>
                        <option value="" disabled>Select a calendar</option>
                        {% for cal in calendars %}
                        <option value="{{ cal.id }}" {% if cal.id==sync.destination_calendar_id %}selected{% endif %}>
                            {{ cal.summary }}
                        </option>
                        {% endfor %}
                    </select>
                    {% else %}
                    <input type="text" id="destination_calendar_id" name="destination_calendar_id"
                        value="{{ sync.destination_calendar_id }}" required>
                    {% endif %}
                    <div class="helper-text">Select the Google Calendar you want to sync events TO.</div>
                </div>

                <div class="form-group">
                    <label>Source Calendars</label>
                    <div class="helper-text" style="margin-bottom: 0.5rem;">
                        Enter the iCal URL and an optional prefix for events from this source.
                    </div>
                    <div id="ical-container">
                        {% for source in sync.sources %}
                        <div class="ical-entry">
                            <input type="text" name="source_urls" value="{{ source.url }}"
                                placeholder="https://example.com/calendar.ics" aria-label="Source Calendar URL"
                                required>
                            <input type="text" name="source_prefixes" value="{{ source.prefix or '' }}"
                                placeholder="Prefix (e.g. Work)" aria-label="Source Event Prefix">
                            <button type="button" class="btn btn-danger" onclick="removeEntry(this)"
                                aria-label="Remove source">Remove</button>
                        </div>
                        {% endfor %}

                        {% if not sources %}
                        <div class="ical-entry">
                            <input type="text" name="source_urls" placeholder="https://example.com/calendar.ics"
                                aria-label="Source Calendar URL" required>
                            <input type="text" name="source_prefixes" placeholder="Prefix (e.g. School)"
                                aria-label="Source Event Prefix">
                            <button type="button" class="btn btn-danger" onclick="removeEntry(this)"
                                style="visibility: hidden;" aria-label="Remove source">Remove</button>
                        </div>
                        {% endif %}
                    </div>
                    <button type="button" class="add-btn" onclick="addIcalInput()">+ Add another Source</button>
                </div>

                <div class="buttons">
                    <a href="/" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">Update Sync</button>
                </div>
            </form>
        </div>
    </main>

    <footer>
        <p>&copy; 2024 CalendarSync. All rights reserved.</p>
    </footer>

    <template id="source-entry-template">
        <div class="ical-entry">
            <input type="text" name="source_urls" placeholder="https://example.com/calendar.ics"
                aria-label="Source Calendar URL" required>
            <input type="text" name="source_prefixes" placeholder="Prefix (e.g. Gym)" aria-label="Source Event Prefix">
            <button type="button" class="btn btn-danger" onclick="removeEntry(this)"
                aria-label="Remove source">Remove</button>
        </div>
    </template>

    <script>
        function addIcalInput() {
            const container = document.getElementById('ical-container');
            const template = document.getElementById('source-entry-template');
            const clone = template.content.cloneNode(true);
            container.appendChild(clone);
            updateRemoveButtons();
        }

        function removeEntry(btn) {
            const entry = btn.closest('.ical-entry');
            entry.remove();
            updateRemoveButtons();
        }

        function updateRemoveButtons() {
            const entries = document.querySelectorAll('.ical-entry');
            entries.forEach((entry, index) => {
                const btn = entry.querySelector('.btn-danger');
                if (entries.length === 1) {
                    btn.style.visibility = 'hidden';
                } else {
                    btn.style.visibility = 'visible';
                }
            });
        }

        // Initial setup for remove buttons
        document.addEventListener('DOMContentLoaded', updateRemoveButtons);
    </script>
</body>

</html>