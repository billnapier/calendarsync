<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description"
              content="Edit your calendar synchronization settings.">
        <meta name="keywords" content="calendar sync, edit, settings">
        <title>Edit Sync - CalendarSync</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
              rel="stylesheet">
        <script src="{{ url_for('static', filename='ui.js') }}" defer></script>
        <script src="{{ url_for('static', filename='sync_form.js') }}" defer></script>
    </head>
    <body>
        <header class="header">
            <a href="{{ url_for('main.index') }}" class="logo-container">
                <img src="{{ url_for('static', filename='images/logo.png') }}"
                     alt="CalendarSync Logo"
                     class="logo-img"
                     width="32"
                     height="32">
                <span class="logo-text">CalendarSync</span>
            </a>
            <div class="user-menu">
                {% if user %}
                    <span>{{ user.name }}</span>
                    <img src="{{ user.picture }}"
                         alt="Profile"
                         class="profile-pic"
                         width="32"
                         height="32">
                    <form action="{{ url_for('main.logout') }}"
                          method="post"
                          class="logout-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <button type="submit" class="btn btn-outline btn-sm">Sign Out</button>
                    </form>
                {% endif %}
            </div>
        </header>
        <main class="dashboard-container">
            <div class="form-card">
                <div class="form-header-group">
                    <h1>Edit Sync</h1>
                    <p class="form-hint">Manage your calendar synchronization settings</p>
                </div>
                <form action="{{ url_for('main.edit_sync', sync_id=sync.id) }}"
                      method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <!-- Destination Section -->
                    <div class="form-group">
                        <label for="destination_calendar_id">Destination Calendar</label>
                        {% if calendars %}
                            <select id="destination_calendar_id" name="destination_calendar_id" required>
                                <option value="" disabled>Select a calendar</option>
                                {% for cal in calendars %}
                                    <option value="{{ cal.id }}"
                                            {% if cal.id==sync.destination_calendar_id %}selected{% endif %}>
                                        {{
                                        cal.summary }}
                                    </option>
                                {% endfor %}
                            </select>
                        {% else %}
                            <input type="text"
                                   id="destination_calendar_id"
                                   name="destination_calendar_id"
                                   value="{{ sync.destination_calendar_id }}"
                                   required>
                        {% endif %}
                        <div class="form-hint">Select the Google Calendar you want to sync events TO.</div>
                    </div>
                    <!-- Sources Section -->
                    <div class="form-group">
                        <label>Source Calendars</label>
                        <details class="help-box">
                            <summary class="help-summary">Need help adding sources?</summary>
                            <div class="help-content">
                                <p class="help-paragraph">
                                    <strong>Which type should I choose?</strong>
                                </p>
                                <ul class="help-list">
                                    <li>
                                        <strong>Google Calendar:</strong> Best for syncing your personal calendars (e.g.,
                                        specific sub-calendars from your own account).
                                    </li>
                                    <li>
                                        <strong>iCal URL:</strong> Use this for external links like Outlook, iCloud,
                                        Teamsnap, or public holiday calendars.
                                    </li>
                                </ul>
                            </div>
                        </details>
                        <div id="ical-container" class="source-list">
                            {% for source in sync.sources %}
                                <div class="ical-entry">
                                    <input type="hidden" name="source_types" value="{{ source.type or 'ical' }}">
                                    <input type="hidden" name="source_ids" value="{{ source.id or '' }}">
                                    <!-- Type Selection -->
                                    <label class="source-type-group">
                                        <span class="field-label">Type</span>
                                        <select>
                                            <option value="ical"
                                                    {% if (source.type or 'ical' )=='ical' %}selected{% endif %}>iCal URL</option>
                                            <option value="google" {% if source.type=='google' %}selected{% endif %}>Google Cal</option>
                                        </select>
                                    </label>
                                    <!-- Source Input (Google/URL) -->
                                    <div class="source-input-group">
                                        <span class="field-label">Source</span>
                                        <!-- Google Input -->
                                        <div class="input-row google-input
                                                    {% if source.type != 'google' %}hidden{% endif %}">
                                            {% if calendars %}
                                                <select name="source_ids_visible" aria-label="Google Calendar Source">
                                                    <option value="" disabled {% if not source.id %}selected{% endif %}>
                                                        Select
                                                        Calendar
                                                    </option>
                                                    {% for cal in calendars %}
                                                        <option value="{{ cal.id }}" {% if cal.id==source.id %}selected{% endif %}>
                                                            {{
                                                            cal.summary }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            {% else %}
                                                <p class="form-hint">No Google Calendars available.</p>
                                            {% endif %}
                                        </div>
                                        <!-- iCal Input -->
                                        <div class="input-row ical-input
                                                    {% if (source.type or 'ical') != 'ical' %}hidden{% endif %}">
                                            <input type="url"
                                                   name="source_urls"
                                                   value="{{ source.url }}"
                                                   placeholder="https://example.com/calendar.ics"
                                                   aria-label="Source Calendar URL"
                                                   inputmode="url">
                                        </div>
                                    </div>
                                    <!-- Prefix Input -->
                                    <label class="source-prefix-group">
                                        <span class="field-label">Prefix (Optional)</span>
                                        <input type="text"
                                               name="source_prefixes"
                                               value="{{ source.prefix or '' }}"
                                               placeholder="e.g. Work"
                                               aria-label="Source Event Prefix">
                                    </label>
                                    <!-- Actions -->
                                    <div class="source-actions">
                                        <span class="field-label visibility-hidden">Remove</span>
                                        <button type="button" class="btn btn-danger btn-icon btn-remove" aria-label="Remove Source" title="Remove Source">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                            {% if not sync.sources %}
                                <!-- Fallback empty state with one row -->
                                <div class="ical-entry">
                                    <input type="hidden" name="source_types" value="ical">
                                    <input type="hidden" name="source_ids" value="">
                                    <label class="source-type-group">
                                        <span class="field-label">Type</span>
                                        <select>
                                            <option value="ical">iCal URL</option>
                                            <option value="google">Google Cal</option>
                                        </select>
                                    </label>
                                    <div class="source-input-group">
                                        <span class="field-label">Source</span>
                                        <div class="input-row google-input hidden">
                                            {% if calendars %}
                                                <select name="source_ids_visible" aria-label="Google Calendar Source">
                                                    <option value="" disabled selected>Select Calendar</option>
                                                    {% for cal in calendars %}<option value="{{ cal.id }}">{{ cal.summary }}</option>{% endfor %}
                                                </select>
                                            {% else %}
                                                <p class="form-hint">No Google Calendars available.</p>
                                            {% endif %}
                                        </div>
                                        <div class="input-row ical-input">
                                            <input type="url"
                                                   name="source_urls"
                                                   placeholder="https://example.com/calendar.ics"
                                                   aria-label="Source Calendar URL"
                                                   inputmode="url">
                                        </div>
                                    </div>
                                    <label class="source-prefix-group">
                                        <span class="field-label">Prefix (Optional)</span>
                                        <input type="text"
                                               name="source_prefixes"
                                               placeholder="e.g. Work"
                                               aria-label="Source Event Prefix">
                                    </label>
                                    <div class="source-actions">
                                        <span class="field-label visibility-hidden">Remove</span>
                                        <button type="button" class="btn btn-danger btn-icon btn-remove" aria-label="Remove Source" title="Remove Source">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        <button type="button" class="add-btn" id="add-source-btn">+ Add another source</button>
                    </div>
                    <div class="form-actions">
                        <a href="{{ url_for('main.index') }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary" data-loading-text="Saving...">Save Changes</button>
                    </div>
                </form>
                <hr class="form-divider">
                <div class="danger-zone">
                    <h3>Delete Sync</h3>
                    <p>This will permanently remove this sync configuration. Your calendars will remain untouched.</p>
                    <form action="{{ url_for('main.delete_sync', sync_id=sync.id) }}"
                          method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <button type="submit"
                                class="btn btn-danger"
                                data-confirm="Are you sure you want to delete this sync? This action cannot be undone.">
                            Delete Sync
                        </button>
                    </form>
                </div>
            </div>
        </main>
        <footer>
            <p>Â© 2024 CalendarSync. All rights reserved.</p>
        </footer>
        <template id="source-entry-template">
            <div class="ical-entry">
                <input type="hidden" name="source_types" value="ical">
                <input type="hidden" name="source_ids" value="">
                <label class="source-type-group">
                    <span class="field-label">Type</span>
                    <select>
                        <option value="ical">iCal URL</option>
                        <option value="google">Google Cal</option>
                    </select>
                </label>
                <div class="source-input-group">
                    <span class="field-label">Source</span>
                    <div class="input-row google-input hidden">
                        {% if calendars %}
                            <select name="source_ids_visible" aria-label="Google Calendar Source">
                                <option value="" disabled selected>Select Calendar</option>
                                {% for cal in calendars %}<option value="{{ cal.id }}">{{ cal.summary }}</option>{% endfor %}
                            </select>
                        {% else %}
                            <p class="form-hint">No Google Calendars available.</p>
                        {% endif %}
                    </div>
                    <div class="input-row ical-input">
                        <input type="url"
                               name="source_urls"
                               placeholder="https://example.com/calendar.ics"
                               aria-label="Source Calendar URL"
                               inputmode="url">
                    </div>
                </div>
                <label class="source-prefix-group">
                    <span class="field-label">Prefix (Optional)</span>
                    <input type="text"
                           name="source_prefixes"
                           placeholder="e.g. Work"
                           aria-label="Source Event Prefix">
                </label>
                <div class="source-actions">
                    <span class="field-label visibility-hidden">Remove</span>
                    <button type="button" class="btn btn-danger btn-icon btn-remove" aria-label="Remove Source" title="Remove Source">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        </template>
    </body>
</html>
