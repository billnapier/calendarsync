<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Create a new calendar synchronization.">
        <meta name="keywords" content="calendar sync, create, new sync">
        <title>Create New Sync - CalendarSync</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
              rel="stylesheet">
        <script src="{{ url_for('static', filename='ui.js') }}" defer></script>
        <script src="{{ url_for('static', filename='sync_form.js') }}" defer></script>
    </head>
    <body>
        <header class="header">
            <a href="{{ url_for('main.index') }}" class="logo-container">
                <img src="{{ url_for('static', filename='images/logo.png') }}"
                     alt="CalendarSync Logo"
                     class="logo-img"
                     width="32"
                     height="32">
                <span class="logo-text">CalendarSync</span>
            </a>
            <div class="user-menu">
                {% if user %}
                    <span>{{ user.name }}</span>
                    <img src="{{ user.picture }}"
                         alt="Profile"
                         class="profile-pic"
                         width="32"
                         height="32">
                    <form action="{{ url_for('main.logout') }}"
                          method="post"
                          class="logout-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <button type="submit" class="btn btn-outline btn-sm">Sign Out</button>
                    </form>
                {% endif %}
            </div>
        </header>
        <main class="dashboard-container">
            <div class="form-card">
                <div class="form-header-group">
                    <h1>Create New Sync</h1>
                    <p class="form-hint">Set up a new synchronization between calendars</p>
                </div>
                <form action="{{ url_for('main.create_sync') }}" method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <!-- Destination Section -->
                    <div class="form-group">
                        <label for="destination_calendar_id">Destination Calendar</label>
                        {% if calendars %}
                            <select id="destination_calendar_id"
                                    name="destination_calendar_id"
                                    required
                                    autofocus>
                                <option value="" disabled selected>Select a calendar</option>
                                {% for cal in calendars %}
                                    <option value="{{ cal.id }}"
                                            {% if cal.summary=='Family' %}selected{% endif %}>{{ cal.summary }}</option>
                                {% endfor %}
                            </select>
                        {% else %}
                            <!-- Fallback if no calendars found or error -->
                            <input type="text"
                                   id="destination_calendar_id"
                                   name="destination_calendar_id"
                                   placeholder="e.g., primary or calendar_id@group.calendar.google.com"
                                   required
                                   autofocus>
                        {% endif %}
                        <div class="form-hint">Select the Google Calendar you want to sync events TO.</div>
                    </div>
                    <!-- Sources Section -->
                    <div class="form-group">
                        <label>Source Calendars</label>
                        <details class="help-box">
                            <summary class="help-summary">Need help adding sources?</summary>
                            <div class="help-content">
                                <p class="help-paragraph">
                                    <strong>Which type should I choose?</strong>
                                </p>
                                <ul class="help-list">
                                    <li>
                                        <strong>Google Calendar:</strong> Best for syncing your personal calendars (e.g.,
                                        specific sub-calendars from your own account).
                                    </li>
                                    <li>
                                        <strong>iCal URL:</strong> Use this for external links like Outlook, iCloud,
                                        Teamsnap, or public holiday calendars.
                                    </li>
                                </ul>
                            </div>
                        </details>
                        <div id="ical-container" class="source-list">
                            <!-- Initial empty state or default row -->
                            <div class="ical-entry">
                                <input type="hidden" name="source_types" value="ical">
                                <input type="hidden" name="source_ids" value="">
                                <!-- Type Selection -->
                                <label class="source-type-group">
                                    <span class="field-label">Type</span>
                                    <select>
                                        <option value="ical">iCal URL</option>
                                        <option value="google">Google Cal</option>
                                    </select>
                                </label>
                                <!-- Source Input -->
                                <div class="source-input-group">
                                    <span class="field-label">Source</span>
                                    <!-- Google Input -->
                                    <div class="input-row google-input hidden">
                                        {% if calendars %}
                                            <select name="source_ids_visible" aria-label="Google Calendar Source">
                                                <option value="" disabled selected>Select Calendar</option>
                                                {% for cal in calendars %}<option value="{{ cal.id }}">{{ cal.summary }}</option>{% endfor %}
                                            </select>
                                        {% else %}
                                            <p class="form-hint">
                                                No Google Calendars found. <a href="{{ url_for('auth.login') }}" class="refresh-link">Refresh?</a>
                                            </p>
                                        {% endif %}
                                    </div>
                                    <!-- iCal Input -->
                                    <div class="input-row ical-input">
                                        <input type="url"
                                               name="source_urls"
                                               placeholder="https://example.com/calendar.ics"
                                               aria-label="Source Calendar URL"
                                               inputmode="url">
                                    </div>
                                </div>
                                <!-- Prefix Input -->
                                <label class="source-prefix-group">
                                    <span class="field-label">Prefix (Optional)</span>
                                    <input type="text"
                                           name="source_prefixes"
                                           placeholder="e.g. Work"
                                           aria-label="Source Event Prefix">
                                </label>
                                <!-- Actions -->
                                <div class="source-actions">
                                    <span class="field-label visibility-hidden">Remove</span>
                                    <button type="button" class="btn btn-danger btn-icon btn-remove" aria-label="Remove Source" title="Remove Source">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="add-btn" id="add-source-btn">+ Add another source</button>
                    </div>
                    <div class="form-actions">
                        <a href="{{ url_for('main.index') }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary" data-loading-text="Creating...">Create Sync</button>
                    </div>
                </form>
            </div>
        </main>
        <footer>
            <p>Â© 2024 CalendarSync. All rights reserved.</p>
        </footer>
        <!-- Template for new rows -->
        <template id="source-entry-template">
            <div class="ical-entry">
                <input type="hidden" name="source_types" value="ical">
                <input type="hidden" name="source_ids" value="">
                <label class="source-type-group">
                    <span class="field-label">Type</span>
                    <select>
                        <option value="ical">iCal URL</option>
                        <option value="google">Google Cal</option>
                    </select>
                </label>
                <div class="source-input-group">
                    <span class="field-label">Source</span>
                    <div class="input-row google-input hidden">
                        {% if calendars %}
                            <select name="source_ids_visible" aria-label="Google Calendar Source">
                                <option value="" disabled selected>Select Calendar</option>
                                {% for cal in calendars %}<option value="{{ cal.id }}">{{ cal.summary }}</option>{% endfor %}
                            </select>
                        {% else %}
                            <p class="form-hint">No Google Calendars available.</p>
                        {% endif %}
                    </div>
                    <div class="input-row ical-input">
                        <input type="url"
                               name="source_urls"
                               placeholder="https://example.com/calendar.ics"
                               aria-label="Source Calendar URL"
                               inputmode="url">
                    </div>
                </div>
                <label class="source-prefix-group">
                    <span class="field-label">Prefix (Optional)</span>
                    <input type="text"
                           name="source_prefixes"
                           placeholder="e.g. Work"
                           aria-label="Source Event Prefix">
                </label>
                <div class="source-actions">
                    <span class="field-label visibility-hidden">Remove</span>
                    <button type="button" class="btn btn-danger btn-icon btn-remove" aria-label="Remove Source" title="Remove Source">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        </template>
    </body>
</html>
